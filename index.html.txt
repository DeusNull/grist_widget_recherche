<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Recherche MD_observations</title>
  <style>
    body { font-family: sans-serif; margin: 10px; }
    label { display: block; margin-top: 6px; }
    input { width: 100%; max-width: 260px; }
    button { margin-top: 10px; }
  </style>
</head>
<body>
  <h3>Formulaire de recherche</h3>

  <label>
    Nom contient :
    <input id="qNom" type="text" placeholder="ex. Dupont">
  </label>

  <label>
    Diagnostic contient :
    <input id="qDiag" type="text" placeholder="ex. phthisie">
  </label>

  <label>
    Âge minimum :
    <input id="qAgeMin" type="number" placeholder="ex. 40">
  </label>

  <button id="btnSearch">Filtrer</button>
  <button id="btnClear">Effacer le filtre</button>

  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <script>
    let records = [];
    let rowIds  = [];

    // Autorise la lecture de la table par le widget.
    grist.ready({ requiredAccess: 'read table' });   // [web:69]

    // Récupère les lignes de la table liée.
    grist.onRecords((data) => {                     // [web:69]
      records = data.records;
      rowIds  = data.rowIds;
    });

    async function applyFilter() {
      const qNom    = document.getElementById('qNom').value.toLowerCase();
      const qDiag   = document.getElementById('qDiag').value.toLowerCase();
      const qAgeMin = parseInt(document.getElementById('qAgeMin').value || '0', 10);

      const keepIds = [];

      records.forEach((r, i) => {
        const nom  = (r.nom || '').toLowerCase();
        const diag = (r.diagnosticprincipalhistorique || '').toLowerCase();
        const age  = r.age || 0;

        if (qNom   && !nom.includes(qNom))   return;
        if (qDiag  && !diag.includes(qDiag)) return;
        if (qAgeMin && age < qAgeMin)        return;

        keepIds.push(rowIds[i]);
      });

      await grist.allowSelectBy();                 // ce widget pilote la sélection [web:101]
      await grist.setSelectedRows(keepIds);        // filtre la table liée
    }

    async function clearFilter() {
      document.getElementById('qNom').value = '';
      document.getElementById('qDiag').value = '';
      document.getElementById('qAgeMin').value = '';
      await grist.allowSelectBy();
      await grist.setSelectedRows([]);             // supprime la sélection (tout réapparaît)
    }

    document.getElementById('btnSearch').addEventListener('click', applyFilter);
    document.getElementById('btnClear').addEventListener('click', clearFilter);
  </script>
</body>
</html>
